local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()
local ThemeManager = loadstring(game:HttpGet(repo .. "addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet(repo .. "addons/SaveManager.lua"))()

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")

local AimParts = {
    HeadHB = Vector3.new(20, 20, 20),
    HumanoidRootPart = Vector3.new(16, 16, 16),
    RightUpperLeg = Vector3.new(14, 14, 14),
}

local AimEnabled = false
local SilentAim = false
local HitChance = 100
local SilentFOV = 150
local TeamCheck = true
local ResolverEnabled = false

local ESPEnabled = false
local BoxESP = false
local NameESP = false
local TracerESP = false
local HealthESP = false
local DistanceESP = false
local MaxESPDistance = 300
local ESPColor = Color3.fromRGB(255, 255, 255)

local CrosshairEnabled = false
local CrosshairSize = 10
local CrosshairGap = 6
local CrosshairThickness = 2
local CrosshairColor = Color3.fromRGB(255, 255, 255)

local WalkSpeedValue = 16
local InfJump = false
local AntiAFK = false

local WeatherMode = "Clear"
local WeatherIntensity = 1

local FPSBoost = false
local AutoFPS = false
local FPSCap = 60
local LowFPSThreshold = 35

local StatusPanelEnabled = true

local ColorFX = Instance.new("ColorCorrectionEffect", Lighting)
local Bloom = Instance.new("BloomEffect", Lighting)
local Atmosphere = Instance.new("Atmosphere", Lighting)

local Rain = Instance.new("ParticleEmitter")
Rain.Rate = 600
Rain.Speed = NumberRange.new(80)
Rain.Lifetime = NumberRange.new(1)
Rain.Texture = "rbxassetid://4817809188"
Rain.Enabled = false

local Snow = Instance.new("ParticleEmitter")
Snow.Rate = 200
Snow.Speed = NumberRange.new(10)
Snow.Lifetime = NumberRange.new(4)
Snow.Texture = "rbxassetid://8158344433"
Snow.Enabled = false

local WeatherPart = Instance.new("Part", workspace)
WeatherPart.Anchored = true
WeatherPart.CanCollide = false
WeatherPart.Transparency = 1
WeatherPart.Size = Vector3.new(500, 1, 500)
WeatherPart.Position = Vector3.new(0, 200, 0)

Rain.Parent = WeatherPart
Snow.Parent = WeatherPart

ColorFX.Saturation = 0.05
ColorFX.Contrast = 0.05
Bloom.Intensity = 0.6
Bloom.Size = 32
Bloom.Threshold = 1
Atmosphere.Density = 0.3
Atmosphere.Offset = 0.25
Atmosphere.Glare = 0.1
Atmosphere.Haze = 1

local StatusPanel = Drawing.new("Text")
StatusPanel.Size = 14
StatusPanel.Outline = true
StatusPanel.Position = Vector2.new(20, 60)
StatusPanel.Color = Color3.fromRGB(255, 255, 255)
StatusPanel.Visible = StatusPanelEnabled
StatusPanel.Center = false

local CrosshairLines = {}
for i = 1, 4 do
    local l = Drawing.new("Line")
    l.Visible = false
    table.insert(CrosshairLines, l)
end

local ESPObjects = {}
local function removeESP(plr)
    if ESPObjects[plr] then
        for _, obj in pairs(ESPObjects[plr]) do
            obj:Remove()
        end
        ESPObjects[plr] = nil
    end
end

local function createESP(plr)
    local box = Drawing.new("Square")
    local name = Drawing.new("Text")
    local tracer = Drawing.new("Line")
    local hp = Drawing.new("Line")
    local dist = Drawing.new("Text")
    box.Thickness = 2
    box.Filled = false
    name.Size = 14
    name.Center = true
    name.Outline = true
    tracer.Thickness = 2
    hp.Thickness = 4
    dist.Size = 14
    dist.Outline = true
    ESPObjects[plr] = {Box = box, Name = name, Tracer = tracer, HP = hp, Dist = dist}
end

local function getHumanoid(plr)
    if plr.Character then
        return plr.Character:FindFirstChildOfClass("Humanoid")
    end
end

local function getRoot(plr)
    if plr.Character then
        return plr.Character:FindFirstChild("HumanoidRootPart")
    end
end

local function setFPSBoost(v)
    if v then
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 1e9
        Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj:IsA("ParticleEmitter") then
                obj.Rate = 0
            end
        end
    else
        Lighting.GlobalShadows = true
        Lighting.FogEnd = 1000
        Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
    end
end

local fpsHistory = {}
local function getFPS()
    local sum = 0
    for _, v in ipairs(fpsHistory) do sum = sum + v end
    return #fpsHistory > 0 and sum / #fpsHistory or 60
end

local function autoFPSControl()
    local fps = getFPS()
    if fps < LowFPSThreshold then
        setFPSBoost(true)
    end
end

RunService.RenderStepped:Connect(function(dt)
    table.insert(fpsHistory, 1 / dt)
    if #fpsHistory > 60 then
        table.remove(fpsHistory, 1)
    end

    if AutoFPS then
        autoFPSControl()
    end

    StatusPanel.Visible = StatusPanelEnabled

    if CrosshairEnabled then
        local c = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
        local g, s = CrosshairGap, CrosshairSize
        local data = {
            {Vector2.new(0, -g), Vector2.new(0, -g - s)},
            {Vector2.new(0, g), Vector2.new(0, g + s)},
            {Vector2.new(-g, 0), Vector2.new(-g - s, 0)},
            {Vector2.new(g, 0), Vector2.new(g + s, 0)}
        }
        for i, l in ipairs(CrosshairLines) do
            l.From = c + data[i][1]
            l.To = c + data[i][2]
            l.Color = CrosshairColor
            l.Thickness = CrosshairThickness
            l.Visible = true
        end
    else
        for _, l in ipairs(CrosshairLines) do
            l.Visible = false
        end
    end

    WeatherPart.Position = Camera.CFrame.Position + Vector3.new(0, 80, 0)
    if WeatherMode == "Rain" then
        Rain.Enabled = true
        Snow.Enabled = false
        Rain.Rate = 200 * WeatherIntensity
    elseif WeatherMode == "Snow" then
        Rain.Enabled = false
        Snow.Enabled = true
        Snow.Rate = 80 * WeatherIntensity
    else
        Rain.Enabled = false
        Snow.Enabled = false
    end

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChild("Humanoid") then
            if ESPEnabled then
                if not ESPObjects[plr] then
                    createESP(plr)
                end

                local root = plr.Character.HumanoidRootPart
                local pos, onScreen = Camera:WorldToViewportPoint(root.Position)
                local esp = ESPObjects[plr]

                if onScreen then
                    local distStuds = (root.Position - Camera.CFrame.Position).Magnitude
                    if distStuds <= MaxESPDistance then
                        local size = Vector2.new(2000 / pos.Z, 3000 / pos.Z)
                        local fade = 1 - (distStuds / MaxESPDistance)
                        local color = ESPColor:Lerp(Color3.fromRGB(255, 255, 255), 1 - fade)

                        esp.Box.Size = size
                        esp.Box.Position = Vector2.new(pos.X - size.X / 2, pos.Y - size.Y / 2)
                        esp.Box.Color = color
                        esp.Box.Visible = BoxESP

                        esp.Name.Text = plr.Name
                        esp.Name.Position = Vector2.new(pos.X, pos.Y - size.Y / 2 - 14)
                        esp.Name.Color = color
                        esp.Name.Visible = NameESP

                        esp.Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                        esp.Tracer.To = Vector2.new(pos.X, pos.Y)
                        esp.Tracer.Color = color
                        esp.Tracer.Visible = TracerESP

                        local humanoid = plr.Character.Humanoid
                        local hpPercent = humanoid.Health / humanoid.MaxHealth
                        local hpStart = Vector2.new(pos.X - size.X / 2 - 6, pos.Y + size.Y / 2)
                        local hpEnd = Vector2.new(pos.X - size.X / 2 - 6, pos.Y + size.Y / 2 - size.Y * hpPercent)
                        esp.HP.From = hpStart
                        esp.HP.To = hpEnd
                        esp.HP.Color = Color3.fromRGB(0, 255, 0)
                        esp.HP.Visible = HealthESP

                        esp.Dist.Text = tostring(math.floor(distStuds)) .. "m"
                        esp.Dist.Position = Vector2.new(pos.X, pos.Y + size.Y / 2 + 6)
                        esp.Dist.Color = color
                        esp.Dist.Visible = DistanceESP
                    else
                        esp.Box.Visible = false
                        esp.Name.Visible = false
                        esp.Tracer.Visible = false
                        esp.HP.Visible = false
                        esp.Dist.Visible = false
                    end
                else
                    esp.Box.Visible = false
                    esp.Name.Visible = false
                    esp.Tracer.Visible = false
                    esp.HP.Visible = false
                    esp.Dist.Visible = false
                end
            else
                removeESP(plr)
            end
        else
            removeESP(plr)
        end
    end
end)

UserInputService.JumpRequest:Connect(function()
    if InfJump and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

task.spawn(function()
    while true do
        if AntiAFK then
            VirtualUser:Button2Down(Vector2.new(0, 0), Camera.CFrame)
            task.wait(1)
            VirtualUser:Button2Up(Vector2.new(0, 0), Camera.CFrame)
        end
        task.wait(30)
    end
end)

local function isTeamMate(plr)
    if not TeamCheck then return false end
    return plr.Team == LocalPlayer.Team
end

local function getClosestTarget()
    local closest = nil
    local closestDist = math.huge

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChildOfClass("Humanoid") and plr.Character.Humanoid.Health > 0 then
            if not isTeamMate(plr) then
                for partName, size in pairs(AimParts) do
                    local part = plr.Character:FindFirstChild(partName)
                    if part then
                        local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                        if onScreen then
                            local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
                            local dist = (Vector2.new(pos.X, pos.Y) - screenCenter).Magnitude

                            if dist < closestDist and dist <= SilentFOV then
                                closestDist = dist
                                closest = {player = plr, part = part}
                            end
                        end
                    end
                end
            end
        end
    end

    return closest
end

RunService.RenderStepped:Connect(function()
    if AimEnabled and SilentAim then
        local target = getClosestTarget()
        if target then
            if math.random(1, 100) <= HitChance then
                local aimPos = target.part.Position
                if ResolverEnabled then
                    aimPos = aimPos + target.part.Velocity * 0.12
                end

                local screenPos, onScreen = Camera:WorldToViewportPoint(aimPos)
                if onScreen then
                    local mouse = LocalPlayer:GetMouse()
                    mousemoverel((screenPos.X - mouse.X), (screenPos.Y - mouse.Y))
                end
            end
        end
    end
end)

local Window = Library:CreateWindow({
    Title = "TanqR Obsidian",
    Footer = "TanqR x Obsidian",
    NotifySide = "Right",
    ShowCustomCursor = true
})

local Tabs = {
    Main = Window:AddTab("Main","crosshair"),
    Visuals = Window:AddTab("Visuals","eye"),
    Player = Window:AddTab("Player","user"),
    World = Window:AddTab("World","globe"),
    Crosshair = Window:AddTab("Crosshair","target"),
    Misc = Window:AddTab("Misc","settings"),
    UI = Window:AddTab("UI","settings")
}

local Combat = Tabs.Main:AddLeftGroupbox("Combat")
Combat:AddToggle("Aim",{Text="TanqR Aim"}):OnChanged(function(v) AimEnabled=v end)
Combat:AddToggle("Silent",{Text="Silent Aim"}):OnChanged(function(v) SilentAim=v end)
Combat:AddSlider("Chance",{Text="Hit Chance",Min=0,Max=100,Default=100}):OnChanged(function(v) HitChance=v end)
Combat:AddSlider("FOV",{Text="Silent FOV",Min=50,Max=400,Default=150}):OnChanged(function(v) SilentFOV=v end)
Combat:AddToggle("Team",{Text="Team Check"}):OnChanged(function(v) TeamCheck=v end)
Combat:AddToggle("Resolver",{Text="Resolver"}):OnChanged(function(v) ResolverEnabled=v end)

local AimPartBox = Tabs.Main:AddRightGroupbox("Aim Parts")
AimPartBox:AddToggle("HeadHB",{Text="HeadHB",Default=true}):OnChanged(function(v) AimParts.HeadHB = v and Vector3.new(20,20,20) or nil end)
AimPartBox:AddToggle("HumanoidRootPart",{Text="HumanoidRootPart",Default=true}):OnChanged(function(v) AimParts.HumanoidRootPart = v and Vector3.new(16,16,16) or nil end)
AimPartBox:AddToggle("RightUpperLeg",{Text="RightUpperLeg",Default=false}):OnChanged(function(v) AimParts.RightUpperLeg = v and Vector3.new(14,14,14) or nil end)
AimPartBox:AddSlider("UpperLegSize",{Text="Upper Leg Size",Min=0,Max=20,Default=14}):OnChanged(function(v)
    if AimParts.RightUpperLeg then
        AimParts.RightUpperLeg = Vector3.new(v,v,v)
    end
end)

local ESPBox = Tabs.Visuals:AddLeftGroupbox("ESP")
ESPBox:AddToggle("Enable",{Text="Enable ESP"}):OnChanged(function(v) ESPEnabled=v end)
ESPBox:AddToggle("Box",{Text="Box ESP"}):OnChanged(function(v) BoxESP=v end)
ESPBox:AddToggle("Name",{Text="Name ESP"}):OnChanged(function(v) NameESP=v end)
ESPBox:AddToggle("Tracer",{Text="Tracers"}):OnChanged(function(v) TracerESP=v end)
ESPBox:AddToggle("Health",{Text="Health Bars"}):OnChanged(function(v) HealthESP=v end)
ESPBox:AddToggle("Distance",{Text="Distance"}):OnChanged(function(v) DistanceESP=v end)

local ESPRight = Tabs.Visuals:AddRightGroupbox("ESP Settings")
ESPRight:AddSlider("MaxDist",{Text="Max ESP Distance",Min=50,Max=1000,Default=300}):OnChanged(function(v) MaxESPDistance=v end)
ESPRight:AddColorPicker("ESPColor",{Text="ESP Color",Default=ESPColor}):OnChanged(function(v) ESPColor=v end)

local PlayerBox = Tabs.Player:AddLeftGroupbox("Movement")
PlayerBox:AddSlider("Speed",{Text="Walk Speed",Min=10,Max=50,Default=16}):OnChanged(function(v)
    WalkSpeedValue=v
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = v
    end
end)
PlayerBox:AddToggle("InfJump",{Text="Infinite Jump"}):OnChanged(function(v) InfJump=v end)

local PlayerRight = Tabs.Player:AddRightGroupbox("Extras")
PlayerRight:AddToggle("AntiAFK",{Text="Anti AFK"}):OnChanged(function(v) AntiAFK=v end)

local WorldLeft = Tabs.World:AddLeftGroupbox("Weather")
WorldLeft:AddDropdown("Weather",{Text="Weather",Values={"Clear","Rain","Snow"},Default="Clear"}):OnChanged(function(v) WeatherMode=v end)
WorldLeft:AddSlider("Intensity",{Text="Weather Intensity",Min=0,Max=5,Default=1}):OnChanged(function(v) WeatherIntensity=v end)

local WorldRight = Tabs.World:AddRightGroupbox("Shaders")
WorldRight:AddDropdown("Shader",{Text="Visual Preset",Values={"Clean","Cinematic","Vibrant"},Default="Clean"}):OnChanged(function(v)
    if v=="Clean" then
        ColorFX.Saturation=0.05
        ColorFX.Contrast=0.05
    elseif v=="Cinematic" then
        ColorFX.Saturation=-0.1
        ColorFX.Contrast=0.25
    else
        ColorFX.Saturation=0.3
        ColorFX.Contrast=0.15
    end
end)

local CrossLeft = Tabs.Crosshair:AddLeftGroupbox("Crosshair")
CrossLeft:AddToggle("Enable",{Text="Enable"}):OnChanged(function(v) CrosshairEnabled=v end)
CrossLeft:AddSlider("Size",{Text="Size",Min=4,Max=20,Default=10}):OnChanged(function(v) CrosshairSize=v end)
CrossLeft:AddSlider("Gap",{Text="Gap",Min=2,Max=15,Default=6}):OnChanged(function(v) CrosshairGap=v end)

local CrossRight = Tabs.Crosshair:AddRightGroupbox("Appearance")
CrossRight:AddSlider("Thickness",{Text="Thickness",Min=1,Max=5,Default=2}):OnChanged(function(v) CrosshairThickness=v end)
CrossRight:AddColorPicker("Color",{Text="Color",Default=CrosshairColor}):OnChanged(function(v) CrosshairColor=v end)

local MiscLeft = Tabs.Misc:AddLeftGroupbox("General")
MiscLeft:AddToggle("StatusPanel",{Text="Status Panel"}):OnChanged(function(v) StatusPanelEnabled=v end)
MiscLeft:AddToggle("AntiAFK",{Text="Anti AFK"}):OnChanged(function(v) AntiAFK=v end)

local MiscRight = Tabs.Misc:AddRightGroupbox("Performance")
MiscRight:AddToggle("FPSBoost",{Text="FPS Boost"}):OnChanged(function(v) FPSBoost=v setFPSBoost(v) end)
MiscRight:AddToggle("AutoFPS",{Text="Auto FPS"}):OnChanged(function(v) AutoFPS=v end)
MiscRight:AddSlider("FPSCap",{Text="FPS Cap",Min=30,Max=144,Default=60}):OnChanged(function(v) FPSCap=v end)
MiscRight:AddSlider("LowFPS",{Text="Low FPS Threshold",Min=20,Max=60,Default=35}):OnChanged(function(v) LowFPSThreshold=v end)

local UIGroup = Tabs.UI:AddLeftGroupbox("Menu")
UIGroup:AddToggle("KeybindMenuOpen", {
    Default = Library.KeybindFrame.Visible,
    Text = "Open Keybind Menu",
    Callback = function(v)
        Library.KeybindFrame.Visible = v
    end
})
UIGroup:AddToggle("ShowCustomCursor", {
    Text = "Custom Cursor",
    Default = true,
    Callback = function(v)
        Library.ShowCustomCursor = v
    end
})
UIGroup:AddDropdown("NotificationSide", {
    Values = {"Left", "Right"},
    Default = "Right",
    Text = "Notification Side",
    Callback = function(v)
        Library:SetNotifySide(v)
    end
})
UIGroup:AddDropdown("DPIDropdown", {
    Values = {"50%", "75%", "100%", "125%", "150%", "175%", "200%"},
    Default = "100%",
    Text = "DPI Scale",
    Callback = function(v)
        v = v:gsub("%%", "")
        Library:SetDPIScale(tonumber(v))
    end
})
UIGroup:AddDivider()
UIGroup:AddLabel("Menu bind"):AddKeyPicker("MenuKeybind", {Default = "RightShift", NoUI = true, Text = "Menu keybind"})
UIGroup:AddButton("Unload", function() Library:Unload() end)

Library.ToggleKeybind = Options.MenuKeybind

ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
SaveManager:IgnoreThemeSettings()
SaveManager:SetFolder("TanqRHub/configs")
SaveManager:BuildConfigSection(Tabs.UI)
ThemeManager:ApplyToTab(Tabs.UI)
SaveManager:LoadAutoloadConfig()
